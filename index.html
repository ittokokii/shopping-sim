<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<!-- ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ï¼šæœ€å¤§å€ç‡1ï¼†ãƒ¦ãƒ¼ã‚¶ãƒ¼æ‹¡å¤§ä¸å¯ -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ãŠè²·ã„ç‰©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
<style>
  :root{
    --bg:#f4f6fb; --panel:#fff; --text:#111; --muted:#666;
    --btn:#4caf50; --btn2:#1f6feb; --danger:#e53935; --border:#e5e7eb;
    --paper:#fffef8; --ink:#0b0b0b; --ink-soft:#3a3a3a;
  }
  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--text); margin:0;
    /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ“ä½œã¯â€œæ“ä½œâ€ã¨ã—ã¦æ‰±ã„ã€ã‚ºãƒ¼ãƒ ã‚’èª˜ç™ºã—ã«ãã */
    touch-action: manipulation;
  }
  .container{max-width:860px;margin:0 auto;padding:20px}
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:20px; margin-bottom:18px}
  h1,h2{margin:0 0 12px}
  .btn{cursor:pointer; border:none; border-radius:8px; padding:10px 14px; color:#fff}
  .btn.green{background:var(--btn)}
  .btn.blue{background:var(--btn2)}
  .btn.red{background:var(--danger)}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px}
  .card{background:#fafafa;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  input{width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px}
  .cart-btn{position:relative}
  .cart-count{position:absolute; top:-6px; right:-6px; background:#e11d48; color:#fff; border-radius:999px; padding:2px 7px; font-size:12px; min-width:20px; text-align:center}
  table{width:100%; border-collapse:collapse}
  th,td{padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:left}

  /* --- ãƒ†ãƒ³ã‚­ãƒ¼ --- */
  .numpad{
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:8px; margin-top:12px;
  }
  .numpad button{
    padding:16px; font-size:18px; border:none; border-radius:8px; background:#e2e8f0; cursor:pointer;
    touch-action: manipulation; /* ãƒœã‚¿ãƒ³å˜ä½“ã§ã‚‚ã‚ºãƒ¼ãƒ æŠ‘æ­¢ */
  }
  .numpad button:active{background:#cbd5e1}
  .display{
    font-size:22px; font-weight:700; text-align:right; padding:10px; margin-top:8px;
    border:1px solid #cbd5e1; border-radius:8px; background:#f8fafc;
  }

  /* ===== æ„Ÿç†±ãƒ¬ã‚·ãƒ¼ãƒˆé¢¨ ===== */
  .receipt-wrap{ display:flex; justify-content:center; }
  .receipt{
    width:320px; margin:0 auto; color:var(--ink); background:
      linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,0)) 0 0/100% 10px no-repeat,
      radial-gradient(120% 20px at 50% 0, rgba(0,0,0,.08), transparent 60%) no-repeat,
      var(--paper);
    border:1px solid #e9e4d8; border-radius:10px; padding:14px 14px 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace;
    box-shadow: 0 10px 25px rgba(0,0,0,.12); position:relative;
  }
  .receipt:before, .receipt:after{
    content:""; position:absolute; left:0; right:0; height:8px;
    background: repeating-linear-gradient(90deg, transparent 0 6px, rgba(0,0,0,.08) 6px 7px, transparent 7px 13px);
  }
  .receipt:before{ top:-6px; } .receipt:after{ bottom:-6px; }
  .r-title{ text-align:center; font-weight:700; letter-spacing:.08em; margin-bottom:6px }
  .r-sub{ text-align:center; font-size:12px; color:var(--ink-soft); margin-bottom:8px }
  .r-kv{ display:grid; grid-template-columns: 1fr auto; gap:4px 8px; font-size:12px; color:#333; margin-bottom:8px }
  .r-line{ border-top:1px dashed #cfcab8; margin:6px 0 }
  .r-items{ display:grid; grid-template-columns: 1fr auto; row-gap:6px; column-gap:8px; font-size:14px }
  .r-items small{ color:#666 }
  .r-sum{ display:grid; grid-template-columns: 1fr auto; gap:6px 8px; font-size:14px; margin-top:6px }
  .r-strong{ font-weight:800 }
  .r-barcode{
    margin:10px auto 0; height:42px; width:85%;
    background: repeating-linear-gradient(90deg, #111 0 2px, transparent 2px 4px, #111 4px 6px, transparent 6px 8px);
    border-radius:3px; opacity:.75;
  }
  .status{margin-top:12px;padding:10px;border-radius:8px;text-align:center}
  .ok{background:#e8f6ee}
  .bad{background:#fde8e8}
  .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap}

  @media print {
    body{background:#fff}
    .panel{box-shadow:none;border:none}
    .receipt{box-shadow:none}
    .footer{display:none}
  }
</style>
</head>
<body>
<div class="container">

  <!-- 1) ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆåå‰ï¼‹ãƒ†ãƒ³ã‚­ãƒ¼æ‰€æŒé‡‘ï¼‰ -->
  <div id="startPanel" class="panel">
    <h1>ğŸ›’ è²·ã„ç‰©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
    <p>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨æ‰€æŒé‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    <div class="row">
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
        <input type="text" id="nameInput" placeholder="ä¾‹ï¼šAã•ã‚“ / ãƒãƒ¼ãƒ 1" />
      </div>
      <div>
        <label style="margin-top:12px;display:block">æ‰€æŒé‡‘ï¼ˆå††ï¼‰</label>
        <div id="walletDisplay" class="display">0</div>
        <div class="numpad">
          <button>7</button><button>8</button><button>9</button>
          <button>4</button><button>5</button><button>6</button>
          <button>1</button><button>2</button><button>3</button>
          <button>0</button><button>00</button><button>â†</button>
          <button style="grid-column:1/4;background:#f87171;color:#fff">C</button>
        </div>
      </div>
    </div>
    <small style="color:#666">â€» å•†å“ãƒªã‚¹ãƒˆã§ã¯ä¾¡æ ¼ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚ä¼šè¨ˆå¾Œã®ãƒ¬ã‚·ãƒ¼ãƒˆã§åˆã‚ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</small><br><br>
    <button id="startBtn" class="btn green">é–‹å§‹</button>
  </div>

  <!-- 2) å•†å“ãƒªã‚¹ãƒˆï¼ˆä¾¡æ ¼éè¡¨ç¤ºï¼‰ -->
  <div id="shopPanel" class="panel" style="display:none">
    <h2>å•†å“ãƒªã‚¹ãƒˆ</h2>
    <button id="openCartBtn" class="btn blue cart-btn">ã‚«ãƒ¼ãƒˆ <span id="cartCount" class="cart-count">0</span></button>
    <div id="productGrid" class="grid" style="margin-top:14px"></div>
  </div>

  <!-- 3) ã‚«ãƒ¼ãƒˆï¼ˆåˆè¨ˆã¯ä¼šè¨ˆæ™‚ã¾ã§éè¡¨ç¤ºï¼‰ -->
  <div id="cartPanel" class="panel" style="display:none">
    <h2>ã‚«ãƒ¼ãƒˆ</h2>
    <div id="cartEmpty">ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™ã€‚</div>
    <table id="cartTable" style="display:none">
      <thead><tr><th>å•†å“</th><th>æ•°é‡</th><th>æ“ä½œ</th></tr></thead>
      <tbody id="cartBody"></tbody>
    </table>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <small style="margin-right:auto;color:#64748b">â€» åˆè¨ˆé‡‘é¡ã¯ä¼šè¨ˆæ™‚ã«ã®ã¿é–‹ç¤ºã—ã¾ã™ã€‚</small>
      <button id="checkoutBtn" class="btn green">ä¼šè¨ˆã™ã‚‹</button>
    </div>
  </div>

  <!-- 4) ãƒ¬ã‚·ãƒ¼ãƒˆå°‚ç”¨ç”»é¢ -->
  <div id="finalPanel" class="panel" style="display:none">
    <h2>ãƒ¬ã‚·ãƒ¼ãƒˆ</h2>
    <div class="receipt-wrap">
      <div id="receiptPaper" class="receipt" aria-label="è³¼å…¥ãƒ¬ã‚·ãƒ¼ãƒˆ">
        <div class="r-title">Hello Market</div>
        <div class="r-sub">â€“ ã„ã¤ã‚‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ â€“</div>
        <div class="r-kv" id="rMeta"></div>
        <div class="r-line"></div>
        <div class="r-items" id="rItems"></div>
        <div class="r-line"></div>
        <div class="r-sum" id="rSum"></div>
        <div class="r-barcode" aria-hidden="true"></div>
      </div>
    </div>
    <div id="finalStatus" class="status" role="status" aria-live="polite"></div>
    <div class="footer">
      <button id="saveBtn" class="btn blue">ç™ºè¡Œï¼ˆç”»åƒä¿å­˜ï¼‰</button>
      <button id="retryBtn" class="btn green">ãƒªãƒˆãƒ©ã‚¤</button>
      <button id="resetBtn" class="btn red">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</div>

<!-- html2canvasï¼ˆç”»åƒä¿å­˜ç”¨ï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ====== è¨­å®šï¼šä¾¡æ ¼ã¯å†…éƒ¨ã®ã¿ ====== */
const products = [
  { id:'p_apple',   name:'ã‚Šã‚“ã”',      price:120 },
  { id:'p_banana',  name:'ãƒãƒŠãƒŠ',      price:90  },
  { id:'p_bread',   name:'é£Ÿãƒ‘ãƒ³',      price:180 },
  { id:'p_milk',    name:'ç‰›ä¹³',        price:160 },
  { id:'p_snack',   name:'ãŠè“å­',      price:150 },
  { id:'p_water',   name:'æ°´(2L)',      price:100 },
  { id:'p_bento',   name:'ãŠå¼å½“',      price:498 },
];

let wallet=null, playerName='', cart={}, checkedOut=false;

/* ====== è¦ç´  ====== */
const startPanel=document.getElementById('startPanel');
const shopPanel=document.getElementById('shopPanel');
const cartPanel=document.getElementById('cartPanel');
const finalPanel=document.getElementById('finalPanel');

const productGrid=document.getElementById('productGrid');
const cartCnt=document.getElementById('cartCount');
const cartBody=document.getElementById('cartBody');
const cartEmpty=document.getElementById('cartEmpty');
const cartTable=document.getElementById('cartTable');

const receiptPaper=document.getElementById('receiptPaper');
const rMeta=document.getElementById('rMeta');
const rItems=document.getElementById('rItems');
const rSum=document.getElementById('rSum');
const finalStatus=document.getElementById('finalStatus');

/* ====== util ====== */
const yen = n => n.toLocaleString('ja-JP');
const esc = s => String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const nowStr = () => {
  const d = new Date();
  const z = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
};

/* ====== ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆiOS/Safariå¯¾ç­–ï¼‰ ====== */
let lastTouchEnd = 0;
document.addEventListener('touchend', (e)=>{
  const now = Date.now();
  if(now - lastTouchEnd <= 300){
    e.preventDefault(); // ç›´å‰ã‚¿ãƒƒãƒ—ã‹ã‚‰300msä»¥å†…ã¯ã‚ºãƒ¼ãƒ ã•ã›ãªã„
  }
  lastTouchEnd = now;
}, {passive:false});
document.addEventListener('dblclick', (e)=> e.preventDefault(), {passive:false});

/* ====== ãƒ†ãƒ³ã‚­ãƒ¼å…¥åŠ›å‡¦ç† ====== */
const walletDisplay = document.getElementById('walletDisplay');
document.querySelectorAll('.numpad button').forEach(btn=>{
  btn.onclick=()=>{
    const val = btn.textContent;
    let current = walletDisplay.textContent;
    if(val==="â†"){ walletDisplay.textContent = current.slice(0,-1) || "0"; }
    else if(val==="C"){ walletDisplay.textContent = "0"; }
    else{ if(current==="0") current=""; walletDisplay.textContent = current + val; }
  };
});

/* ====== é–‹å§‹ ====== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const name = document.getElementById('nameInput').value.trim();
  const w = Number(walletDisplay.textContent);
  if(!name){ alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if(!Number.isFinite(w) || w<=0){ alert('æ‰€æŒé‡‘ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  playerName = name; wallet = Math.floor(w); cart={}; checkedOut=false;

  startPanel.style.display='none';
  shopPanel.style.display='block';
  cartPanel.style.display='none';
  finalPanel.style.display='none';
  renderProducts(); updateCartCount();
});

/* ====== å•†å“ï¼šä¾¡æ ¼ã¯è¡¨ç¤ºã—ãªã„ ====== */
function renderProducts(){
  productGrid.innerHTML='';
  products.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div style="font-weight:600">${p.name}</div>
      <button class="btn blue" data-id="${p.id}">ã‚«ãƒ¼ãƒˆã«å…¥ã‚Œã‚‹</button>
    `;
    card.querySelector('button').addEventListener('click', ()=>{
      if(checkedOut) return;
      cart[p.id] = (cart[p.id]||0)+1;
      updateCartCount();
    });
    productGrid.appendChild(card);
  });
}
function updateCartCount(){
  const count = Object.values(cart).reduce((a,b)=>a+b,0);
  cartCnt.textContent = count;
}

/* ====== ã‚«ãƒ¼ãƒˆ ====== */
document.getElementById('openCartBtn').addEventListener('click', ()=>{
  buildCart();
  cartPanel.style.display='block';
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
});
function buildCart(){
  const ids = Object.keys(cart);
  if(ids.length===0){
    cartEmpty.style.display='block';
    cartTable.style.display='none';
    return;
  }
  cartEmpty.style.display='none';
  cartTable.style.display='table';
  cartBody.innerHTML='';
  ids.forEach(id=>{
    const p = products.find(x=>x.id===id);
    const qty = cart[id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${qty}</td>
      <td>
        <button data-act="inc" class="btn blue" style="padding:6px 10px;margin-right:6px">ï¼‹</button>
        <button data-act="dec" class="btn" style="padding:6px 10px;background:#64748b;margin-right:6px">ï¼</button>
        <button data-act="del" class="btn red" style="padding:6px 10px">å‰Šé™¤</button>
      </td>
    `;
    tr.querySelectorAll('button').forEach(btn=>{
      const act=btn.getAttribute('data-act');
      btn.addEventListener('click', ()=>{
        if(act==='inc') cart[id]++;
        if(act==='dec') cart[id]=Math.max(0,cart[id]-1);
        if(act==='del') delete cart[id];
        if(cart[id]===0) delete cart[id];
        updateCartCount();
        buildCart();
      });
    });
    cartBody.appendChild(tr);
  });
}

/* ====== ä¼šè¨ˆ â†’ ãƒ¬ã‚·ãƒ¼ãƒˆæç”»ï¼ˆç¨è¨ˆç®—ãªã— & ä¸è¶³é¡è¡¨ç¤ºï¼‰ ====== */
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  if(checkedOut) return;
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = products.find(x=>x.id===id);
    return {...p, qty, subtotal:p.price*qty};
  });
  if(items.length===0){ alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™'); return; }

  const total = items.reduce((a,b)=>a+b.subtotal,0);
  const qtySum= items.reduce((a,b)=>a+b.qty,0);
  const remain= wallet - total;
  const deficit = Math.max(0, total - wallet); // â† ä¸è¶³é¡
  const receiptNo = Math.random().toString(36).slice(2,8).toUpperCase();

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  rMeta.innerHTML = `
    <div>æ—¥æ™‚</div><div>${nowStr()}</div>
    <div>ãƒ¬ã‚·ãƒ¼ãƒˆNo</div><div>${receiptNo}</div>
    <div>æ‹…å½“</div><div>CM-01</div>
    <div>ãŠå®¢ã•ã¾</div><div>${esc(playerName)}</div>
  `;

  // æ˜ç´°
  rItems.innerHTML = items.map(it => `
    <div>
      ${esc(it.name)} Ã—${it.qty}<br>
      <small>@Â¥${yen(it.price)}</small>
    </div>
    <div style="text-align:right">Â¥${yen(it.subtotal)}</div>
  `).join('');

  // åˆè¨ˆã®ã¿è¡¨ç¤º
  rSum.innerHTML = `
    <div class="r-strong">åˆè¨ˆ</div><div class="r-strong">Â¥${yen(total)}</div>
    <div>ãŠé ã‚Š</div><div>Â¥${yen(wallet)}</div>
    <div>ãŠã¤ã‚Š</div><div>Â¥${yen(Math.max(0, wallet-total))}</div>
    <div>ãŠè²·ä¸Šç‚¹æ•°</div><div>${qtySum} ç‚¹</div>
  `;

  // çµæœï¼ˆä¸è¶³é¡ã®æ˜ç¤ºï¼‰
  finalStatus.className = 'status ' + (remain<0 ? 'bad' : 'ok');
  finalStatus.textContent =
    remain<0 ? `ğŸ’¥ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼æ‰€æŒé‡‘ä¸è¶³ï¼ˆä¸è¶³é¡ï¼šÂ¥${yen(deficit)}ï¼‰` :
    remain===0 ? 'ğŸ¯ ãƒ”ãƒƒã‚¿ãƒªè²·ã„ï¼' :
    `âœ… ä¼šè¨ˆå®Œäº† æ®‹é¡ Â¥${yen(remain)}`;

  // ç”»é¢é·ç§»ï¼šãƒ¬ã‚·ãƒ¼ãƒˆã®ã¿
  shopPanel.style.display='none';
  cartPanel.style.display='none';
  finalPanel.style.display='block';
  checkedOut = true;
});

/* ====== ç™ºè¡Œï¼ˆç”»åƒä¿å­˜ï¼šãƒ¬ã‚·ãƒ¼ãƒˆéƒ¨åˆ†ã®ã¿ï¼‰ ====== */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  html2canvas(receiptPaper, {scale:2, backgroundColor:null}).then(canvas=>{
    const a=document.createElement('a');
    a.download=`receipt_${playerName}.png`;
    a.href=canvas.toDataURL('image/png');
    a.click();
  });
});

/* ====== ãƒªãƒˆãƒ©ã‚¤ï¼ãƒªã‚»ãƒƒãƒˆ ====== */
document.getElementById('retryBtn').addEventListener('click', ()=>{
  cart={}; checkedOut=false; updateCartCount();
  finalPanel.style.display='none';
  shopPanel.style.display='block';
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  playerName=''; wallet=null; cart={}; checkedOut=false;
  document.getElementById('nameInput').value='';
  walletDisplay.textContent='0';
  finalPanel.style.display='none';
  shopPanel.style.display='none';
  cartPanel.style.display='none';
  startPanel.style.display='block';
});
</script>
</body>
</html>
