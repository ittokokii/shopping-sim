<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<!-- ダブルタップズーム防止：最大倍率1＆ユーザー拡大不可 -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>お買い物シミュレーター</title>
<style>
  :root{
    --bg:#f4f6fb; --panel:#fff; --text:#111; --muted:#666;
    --btn:#4caf50; --btn2:#1f6feb; --danger:#e53935; --border:#e5e7eb;
    --paper:#fffef8; --ink:#0b0b0b; --ink-soft:#3a3a3a;
  }
  *{box-sizing:border-box}
  body{
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--text); margin:0;
    /* ダブルタップ操作は“操作”として扱い、ズームを誘発しにくく */
    touch-action: manipulation;
  }
  .container{max-width:860px;margin:0 auto;padding:20px}
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,.06); padding:20px; margin-bottom:18px}
  h1,h2{margin:0 0 12px}
  .btn{cursor:pointer; border:none; border-radius:8px; padding:10px 14px; color:#fff}
  .btn.green{background:var(--btn)}
  .btn.blue{background:var(--btn2)}
  .btn.red{background:var(--danger)}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:12px}
  .card{background:#fafafa;border:1px solid #e2e8f0;border-radius:10px;padding:12px;text-align:center}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  input{width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px}
  .cart-btn{position:relative}
  .cart-count{position:absolute; top:-6px; right:-6px; background:#e11d48; color:#fff; border-radius:999px; padding:2px 7px; font-size:12px; min-width:20px; text-align:center}
  table{width:100%; border-collapse:collapse}
  th,td{padding:8px 10px; border-bottom:1px solid #e5e7eb; text-align:left}

  /* --- テンキー --- */
  .numpad{
    display:grid; grid-template-columns:repeat(3,1fr);
    gap:8px; margin-top:12px;
  }
  .numpad button{
    padding:16px; font-size:18px; border:none; border-radius:8px; background:#e2e8f0; cursor:pointer;
    touch-action: manipulation; /* ボタン単体でもズーム抑止 */
  }
  .numpad button:active{background:#cbd5e1}
  .display{
    font-size:22px; font-weight:700; text-align:right; padding:10px; margin-top:8px;
    border:1px solid #cbd5e1; border-radius:8px; background:#f8fafc;
  }

  /* ===== 感熱レシート風 ===== */
  .receipt-wrap{ display:flex; justify-content:center; }
  .receipt{
    width:320px; margin:0 auto; color:var(--ink); background:
      linear-gradient(180deg,rgba(0,0,0,.03),rgba(0,0,0,0)) 0 0/100% 10px no-repeat,
      radial-gradient(120% 20px at 50% 0, rgba(0,0,0,.08), transparent 60%) no-repeat,
      var(--paper);
    border:1px solid #e9e4d8; border-radius:10px; padding:14px 14px 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace;
    box-shadow: 0 10px 25px rgba(0,0,0,.12); position:relative;
  }
  .receipt:before, .receipt:after{
    content:""; position:absolute; left:0; right:0; height:8px;
    background: repeating-linear-gradient(90deg, transparent 0 6px, rgba(0,0,0,.08) 6px 7px, transparent 7px 13px);
  }
  .receipt:before{ top:-6px; } .receipt:after{ bottom:-6px; }
  .r-title{ text-align:center; font-weight:700; letter-spacing:.08em; margin-bottom:6px }
  .r-sub{ text-align:center; font-size:12px; color:var(--ink-soft); margin-bottom:8px }
  .r-kv{ display:grid; grid-template-columns: 1fr auto; gap:4px 8px; font-size:12px; color:#333; margin-bottom:8px }
  .r-line{ border-top:1px dashed #cfcab8; margin:6px 0 }
  .r-items{ display:grid; grid-template-columns: 1fr auto; row-gap:6px; column-gap:8px; font-size:14px }
  .r-items small{ color:#666 }
  .r-sum{ display:grid; grid-template-columns: 1fr auto; gap:6px 8px; font-size:14px; margin-top:6px }
  .r-strong{ font-weight:800 }
  .r-barcode{
    margin:10px auto 0; height:42px; width:85%;
    background: repeating-linear-gradient(90deg, #111 0 2px, transparent 2px 4px, #111 4px 6px, transparent 6px 8px);
    border-radius:3px; opacity:.75;
  }
  .status{margin-top:12px;padding:10px;border-radius:8px;text-align:center}
  .ok{background:#e8f6ee}
  .bad{background:#fde8e8}
  .footer{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap}

  @media print {
    body{background:#fff}
    .panel{box-shadow:none;border:none}
    .receipt{box-shadow:none}
    .footer{display:none}
  }
  /* --- カテゴリタブ --- */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{border:1px solid var(--border);background:#f3f4f6;color:#111;border-radius:999px;padding:6px 12px;cursor:pointer}
  .tab.active{background:var(--btn2);color:#fff;border-color:transparent}
</style>
</head>
<body>
<div class="container">

  <!-- 1) スタート画面（名前＋テンキー所持金） -->
  <div id="startPanel" class="panel">
    <h1>🛒 買い物シミュレーター(マックスバリュ津城山)</h1>
    <p>プレイヤー名と所持金を入力してください。</p>
    <div class="row">
      <div>
        <label>プレイヤー名</label>
        <input type="text" id="nameInput" placeholder="例：Aさん / チーム1" />
      </div>
      <div>
        <label style="margin-top:12px;display:block">所持金（円）</label>
        <div id="walletDisplay" class="display">0</div>
        <div class="numpad">
          <button>7</button><button>8</button><button>9</button>
          <button>4</button><button>5</button><button>6</button>
          <button>1</button><button>2</button><button>3</button>
          <button>0</button><button>00</button><button>←</button>
          <button style="grid-column:1/4;background:#f87171;color:#fff">C</button>
        </div>
      </div>
    </div>
    <small style="color:#666">※ 商品リストでは価格は表示されません。会計後のレシートで初めて表示されます。</small><br><br>
    <button id="startBtn" class="btn green">開始</button>
  </div>

  <!-- 2) 商品リスト（価格非表示） -->
  <div id="shopPanel" class="panel" style="display:none">
    <h2>商品リスト</h2>
    <div id="categoryTabs" class="tabs" role="tablist" aria-label="商品カテゴリ"></div>
    <div style="height:4px"></div>
    <button id="openCartBtn" class="btn blue cart-btn">カート <span id="cartCount" class="cart-count">0</span></button>
    <div id="productGrid" class="grid" style="margin-top:14px"></div>
  </div>

  <!-- 3) カート（合計は会計時まで非表示） -->
  <div id="cartPanel" class="panel" style="display:none">
    <h2>カート</h2>
    <div id="cartEmpty">カートは空です。</div>
    <table id="cartTable" style="display:none">
      <thead><tr><th>商品</th><th>数量</th><th>操作</th></tr></thead>
      <tbody id="cartBody"></tbody>
    </table>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <small style="margin-right:auto;color:#64748b">※ 合計金額は会計時にのみ開示します。</small>
      <button id="checkoutBtn" class="btn green">会計する</button>
    </div>
  </div>

  <!-- 4) レシート専用画面 -->
  <div id="finalPanel" class="panel" style="display:none">
    <h2>レシート</h2>
    <div class="receipt-wrap">
      <div id="receiptPaper" class="receipt" aria-label="購入レシート">
        <div class="r-title">Hello Market</div>
        <div class="r-sub">– いつもご利用ありがとうございます –</div>
        <div class="r-kv" id="rMeta"></div>
        <div class="r-line"></div>
        <div class="r-items" id="rItems"></div>
        <div class="r-line"></div>
        <div class="r-sum" id="rSum"></div>
        <div class="r-barcode" aria-hidden="true"></div>
      </div>
    </div>
    <div id="finalStatus" class="status" role="status" aria-live="polite"></div>
    <div class="footer">
      <button id="saveBtn" class="btn blue">発行（画像保存）</button>
      <button id="retryBtn" class="btn green">リトライ</button>
      <button id="resetBtn" class="btn red">リセット</button>
    </div>
  </div>
</div>

<!-- html2canvas（画像保存用） -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* ====== カテゴリ（内部キーと表示名） ====== */
const CATEGORY_LABELS = {
  all:    "すべて",
  yasai:  "野菜・果物",
  niku:   "肉・魚",
  souzai: "総菜・お弁当",
  okashi: "お菓子",
  inryo:  "飲料",
  sonota: "その他",
};
/* タブ表示順 */
const CATEGORY_ORDER = ["all","yasai","niku","souzai","okashi","inryo","sonota"];

// ...CATEGORY_LABELS と CATEGORY_ORDER の下に置く
const products = [
  { id:"p_cab",  name:"キャベツ（1玉）",   price:198, cat:"yasai"  },
  { id:"p_cabhalf",  name:"キャベツ（半玉）",   price:108, cat:"yasai"  },
  { id:"p_br",  name:"ブロッコリー（1株）",   price:298, cat:"yasai"  },
  { id:"p_ab",  name:"アボカド",   price:198, cat:"yasai"  },
  { id:"p_hr",  name:"ほうれん草",   price:258, cat:"yasai"  },
  { id:"p_komatuna",  name:"小松菜",   price:138, cat:"yasai"  },
  { id:"p_nira",  name:"にら",   price:158, cat:"yasai"  },
  { id:"p_dai",  name:"大根（1本）",   price:298, cat:"yasai"  },
  { id:"p_haku",  name:"白菜（1/4）",   price:128, cat:"yasai"  },
  { id:"p_kaiware",  name:"かいわれ大根（1パック）",   price:48, cat:"yasai"  },
  { id:"p_enoki",  name:"えのき",   price:98, cat:"yasai"  },
  { id:"p_buna",  name:"ぶなしめじ",   price:128, cat:"yasai"  },
  { id:"p_mai",  name:"マイタケ",   price:108, cat:"yasai"  },
  { id:"p_eri",  name:"エリンギ",   price:98, cat:"yasai"  },
  { id:"p_moya",  name:"もやし",   price:28, cat:"yasai"  },
  { id:"p_zyaga",  name:"じゃがいも（1個）",   price:58, cat:"yasai"  },
  { id:"p_zyagaset",  name:"じゃがいも（6個1袋）",   price:258, cat:"yasai"  },
  { id:"p_tama",  name:"玉ねぎ（1個）",   price:78, cat:"yasai"  },
  { id:"p_tamaset",  name:"玉ねぎ（3個1ネット）",   price:258, cat:"yasai"  },
  { id:"p_ninn",  name:"にんじん（1個）",   price:98, cat:"yasai"  },
  { id:"p_ninnset",  name:"にんじん（3個1袋）",   price:198, cat:"yasai"  },
  { id:"p_kyoho",  name:"ぶどう（たねなし巨峰）",   price:798, cat:"yasai"  },
  { id:"p_shine",  name:"シャインマスカット",   price:1580, cat:"yasai"  },
  { id:"p_nasi",  name:"なし",   price:298, cat:"yasai"  },
  { id:"p_kiui",  name:"キウイ",   price:118, cat:"yasai"  },
  { id:"p_mikan",  name:"早出しみかん1袋（Mサイズ）",   price:598, cat:"yasai"  },
  { id:"p_bana",  name:"バナナ（1房）",   price:198, cat:"yasai"  },
  { id:"p_app",  name:"りんご",   price:198, cat:"yasai"  },

  { id:"p_usisute",  name:"黒毛和牛ロースステーキ用1枚（170g）",   price:1186, cat:"niku"  },
  { id:"p_usikiriotosi",  name:"黒毛和牛切り落とし400g入1パック",   price:1592, cat:"niku"  },
  { id:"p_usikoma",  name:"国産牛小間切れ（155g）",   price:598, cat:"niku"  },
  { id:"p_usihoru",  name:"牛ホルモン（180g）",   price:458, cat:"niku"  },
  { id:"p_butabara",  name:"伊勢うまし豚ばらスライス（100g）",   price:328, cat:"niku"  },
  { id:"p_butakoma",  name:"伊勢うまし豚小間切れ（100g）",   price:198, cat:"niku"  },
  { id:"p_butasya",  name:"国産豚肉ロースしゃぶしゃぶ用（200g）",   price:356, cat:"niku"  },
  { id:"p_torimomo",  name:"国産若鳥もも肉（300g）",   price:294, cat:"niku"  },
  { id:"p_torisasa",  name:"国産若鳥ささみ肉（200g）",   price:316, cat:"niku"  },
  { id:"p_torimune",  name:"国産若鳥皮なしむね肉（300g）",   price:384, cat:"niku"  },
  { id:"p_ubmin",  name:"国産牛豚ミンチ（200g）",   price:456, cat:"niku"  },
  { id:"p_bmin",  name:"国産豚ミンチ（200g）",   price:256, cat:"niku"  },
  { id:"p_torimin",  name:"国産若鶏むね・皮ミンチ（200g）",   price:276, cat:"niku"  },
  { id:"p_gyoukawa",  name:"餃子の皮（30枚）",   price:90, cat:"niku"  },
  { id:"p_kiha",  name:"台湾産解凍きはだまぐろ刺身用150g",   price:597, cat:"niku"  },
  { id:"p_tataki",  name:"国内産かつおたたき刺身（150g）",   price:342, cat:"niku"  },
  { id:"p_ika",  name:"フィリピン産解凍たるいか刺身用（100g）",   price:438, cat:"niku"  },
  { id:"p_kaibasira",  name:"北海道産ホタテ貝柱生食用（100g）",   price:638, cat:"niku"  },
  { id:"p_buri",  name:"愛媛県産ぶり切身1切れ",   price:418, cat:"niku"  },
  { id:"p_madai",  name:"三重県産養殖真鯛切身1切れ",   price:350, cat:"niku"  },
  { id:"p_tara",  name:"北海道産真たら切身1切れ",   price:208, cat:"niku"  },
  { id:"p_panamei",  name:"インドネシア産パナメイむきえび（130g）",   price:398, cat:"niku"  },
  { id:"p_unagi",  name:"国産うなぎかば焼き1尾",   price:1980, cat:"niku"  },
  { id:"p_kireunagi",  name:"国産切れてるうなぎかば焼き1尾",   price:1980, cat:"niku"  },
  { id:"p_uinnner",  name:"シャウエッセン",   price:398, cat:"niku"  },
  { id:"p_bacon",  name:"ブロックベーコン",   price:298, cat:"niku"  },
  { id:"p_",  name:"ロースハム4袋つづり",   price:278, cat:"niku"  },

  { id:"p_ontama",  name:"温泉卵3個入り",   price:158, cat:"souzai"  },
  { id:"p_maka",  name:"トップバリュマカロニサラダ",   price:128, cat:"souzai"  },
  { id:"p_pote",  name:"トップバリュポテサラ",   price:128, cat:"souzai"  },
  { id:"p_tikuten",  name:"ちくわ天1本",   price:88, cat:"souzai"  },
  { id:"p_satuma",  name:"さつま芋の天ぷら1枚",   price:138, cat:"souzai"  },
  { id:"p_mori",  name:"7種の天ぷら盛り合わせ",   price:398, cat:"souzai"  },
  { id:"p_koro",  name:"トップバリュコロッケ（5個入り）",   price:298, cat:"souzai"  },
  { id:"p_yakitori",  name:"焼き鳥（もも・皮・ねぎま種類問わず2本）",   price:240, cat:"souzai"  },
  { id:"p_sushi",  name:"握りずし（華雅）",   price:798, cat:"souzai"  },
  { id:"p_edamame",  name:"トップバリュ枝豆100g",   price:138, cat:"souzai"  },
  { id:"p_taokosu",  name:"タコの酢の物",   price:198, cat:"souzai"  },

  { id:"p_ritu",  name:"リッツクラッカー箱",   price:218, cat:"okashi"  },
  { id:"p_oreo",  name:"オレオ箱",   price:198, cat:"okashi"  },
  { id:"p_country",  name:"カントリーマアム厳選12枚入り",   price:258, cat:"okashi"  },
  { id:"p_choco",  name:"ガーナ板チョコ",   price:198, cat:"okashi"  },
  { id:"p_whitechoco",  name:"明治ホワイトチョコ",   price:228, cat:"okashi"  },
  { id:"p_hargen",  name:"ハーゲンダッツ",   price:298, cat:"okashi"  },
  { id:"p_mow",  name:"MOW",   price:128, cat:"okashi"  },
  { id:"p_garigari",  name:"ガリガリ君",   price:68, cat:"okashi"  },


  { id:"p_gyuunyu",  name:"明治おいしい牛乳900ml",   price:258, cat:"inryo"  },
  { id:"p_tya",  name:"おーいお茶2L",   price:168, cat:"inryo"  },
  { id:"p_coffee",  name:"uccカップコーヒー5カップ",   price:208, cat:"inryo"  },
  { id:"p_coke",  name:"コカ・コーラ1.5L",   price:178, cat:"inryo"  },
  { id:"p_juice",  name:"家族の潤いジュース（味色々）",   price:118, cat:"inryo"  },
  { id:"p_yasaijuice",  name:"カゴメ野菜生活0.9L",   price:258, cat:"inryo"  },

  { id:"p_egg",  name:"たまごMサイズ（10個入）",   price:278, cat:"sonota"  },
  { id:"p_tohu",  name:"豆腐1丁（木綿or絹）",   price:58, cat:"sonota"  },
  { id:"p_age",  name:"ベストプライスきざみあげ",   price:98, cat:"sonota"  },
  { id:"p_nattou",  name:"ベストプライス納豆",   price:78, cat:"sonota"  },
  { id:"p_konn",  name:"ベストプライスこんにゃく",   price:98, cat:"sonota"  },
  { id:"p_itokon",  name:"ベストプライス糸こんにゃく",   price:98, cat:"sonota"  },
  { id:"p_tiku",  name:"ちくわ5本",   price:98, cat:"sonota"  },
  { id:"p_kanikama",  name:"かにかま",   price:98, cat:"sonota"  },
  { id:"p_maruyaki",  name:"マルちゃん焼きそば3食入",   price:198, cat:"sonota"  },
  { id:"p_soume",  name:"揖保乃糸",   price:348, cat:"sonota"  },
  { id:"p_soba",  name:"ベストプライスそば乾麺（100g×4）",   price:228, cat:"sonota"  },
  { id:"p_pasuta",  name:"トップバリュパスタ500g",   price:128, cat:"sonota"  },
  { id:"p_udon",  name:"ゆでうどん200g",   price:38, cat:"sonota"  },
  { id:"p_makaroni",  name:"トップバリュマカロニ200g",   price:118, cat:"sonota"  },
  { id:"p_curry",  name:"こくまろカレー",   price:178, cat:"sonota"  },
  { id:"p_sityuu",  name:"エスビー濃いシチュー",   price:258, cat:"sonota"  },
  { id:"p_nabe",  name:"プチッと鍋",   price:278, cat:"sonota"  },
  { id:"p_syokupan",  name:"パスコ超熟",   price:178, cat:"sonota"  },
  { id:"p_yogur",  name:"ブルガリアヨーグルト400g",   price:188, cat:"sonota"  },
  { id:"p_bata",  name:"北海道バター200g",   price:548, cat:"sonota"  },
  { id:"p_magari",  name:"ネオソフトマーガリン300g",   price:228, cat:"sonota"  },


];
let wallet=null, playerName='', cart={}, checkedOut=false;

/* ====== 要素 ====== */
const startPanel=document.getElementById('startPanel');
const shopPanel=document.getElementById('shopPanel');
const cartPanel=document.getElementById('cartPanel');
const finalPanel=document.getElementById('finalPanel');

const productGrid=document.getElementById('productGrid');
const categoryTabs = document.getElementById('categoryTabs');
const cartCnt=document.getElementById('cartCount');
const cartBody=document.getElementById('cartBody');
const cartEmpty=document.getElementById('cartEmpty');
const cartTable=document.getElementById('cartTable');

const receiptPaper=document.getElementById('receiptPaper');
const rMeta=document.getElementById('rMeta');
const rItems=document.getElementById('rItems');
const rSum=document.getElementById('rSum');
const finalStatus=document.getElementById('finalStatus');

/* ====== util ====== */
const yen = n => n.toLocaleString('ja-JP');
const esc = s => String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const nowStr = () => {
  const d = new Date();
  const z = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
};

/* ====== ダブルタップズーム抑止（iOS/Safari対策） ====== */
let lastTouchEnd = 0;
document.addEventListener('touchend', (e)=>{
  const now = Date.now();
  if(now - lastTouchEnd <= 300){
    e.preventDefault(); // 直前タップから300ms以内はズームさせない
  }
  lastTouchEnd = now;
}, {passive:false});
document.addEventListener('dblclick', (e)=> e.preventDefault(), {passive:false});

/* ====== テンキー入力処理 ====== */
const walletDisplay = document.getElementById('walletDisplay');
document.querySelectorAll('.numpad button').forEach(btn=>{
  btn.onclick=()=>{
    const val = btn.textContent;
    let current = walletDisplay.textContent;
    if(val==="←"){ walletDisplay.textContent = current.slice(0,-1) || "0"; }
    else if(val==="C"){ walletDisplay.textContent = "0"; }
    else{ if(current==="0") current=""; walletDisplay.textContent = current + val; }
  };
});

/* ====== 開始 ====== */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const name = document.getElementById('nameInput').value.trim();
  const w = Number(walletDisplay.textContent);
  if(!name){ alert('プレイヤー名を入力してください'); return; }
  if(!Number.isFinite(w) || w<=0){ alert('所持金を正しく入力してください'); return; }
  playerName = name; wallet = Math.floor(w); cart={}; checkedOut=false;

  startPanel.style.display='none';
  shopPanel.style.display='block';
  cartPanel.style.display='none';
  finalPanel.style.display='none';
  renderCategoryTabs();enderProducts();updateCartCount();
});

/* ====== カテゴリタブ生成＆選択状態 ====== */
let activeCategory = "all"

function renderCategoryTabs(){
  categoryTabs.innerHTML = '';
  CATEGORY_ORDER.forEach(key=>{
    const btn = document.createElement('button');
    btn.className = 'tab' + (key===activeCategory ? ' active' : '');
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected', String(key===activeCategory));
    btn.textContent = CATEGORY_LABELS[key];
    btn.addEventListener('click', ()=>{
      activeCategory = key;
      renderCategoryTabs();
      renderProducts();
    });
    categoryTabs.appendChild(btn);
  });
}


/* ====== 商品（カテゴリ別に表示。価格は表示しない） ====== */
function renderProducts(){
  productGrid.innerHTML='';
  // 選択中カテゴリの商品に絞り込み
  // 選択中カテゴリの商品に絞り込み（"all" は全件）
  const list = (activeCategory === "all")
    ? products.slice()
    : products.filter(p => p.cat === activeCategory);


  // カテゴリ内に商品が無い場合のメッセージ
  if(list.length === 0){
    const msg = document.createElement('div');
    msg.className = 'card';
    msg.textContent = 'このカテゴリの商品はありません。';
    productGrid.appendChild(msg);
    return;
  }

  // カードを描画
  list.forEach(p=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML = `
      <div style="font-weight:600">${p.name}</div>
      <button class="btn blue" data-id="${p.id}">カートに入れる</button>
    `;
    card.querySelector('button').addEventListener('click', ()=>{
      if(checkedOut) return;
      cart[p.id] = (cart[p.id]||0)+1;
      updateCartCount();
    });
    productGrid.appendChild(card);
  });
}

function updateCartCount(){
  const count = Object.values(cart).reduce((a,b)=>a+b,0);
  cartCnt.textContent = count;
}

/* ====== カート ====== */
document.getElementById('openCartBtn').addEventListener('click', ()=>{
  buildCart();
  cartPanel.style.display='block';
  window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
});
function buildCart(){
  const ids = Object.keys(cart);
  if(ids.length===0){
    cartEmpty.style.display='block';
    cartTable.style.display='none';
    return;
  }
  cartEmpty.style.display='none';
  cartTable.style.display='table';
  cartBody.innerHTML='';
  ids.forEach(id=>{
    const p = products.find(x=>x.id===id);
    const qty = cart[id];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${qty}</td>
      <td>
        <button data-act="inc" class="btn blue" style="padding:6px 10px;margin-right:6px">＋</button>
        <button data-act="dec" class="btn" style="padding:6px 10px;background:#64748b;margin-right:6px">－</button>
        <button data-act="del" class="btn red" style="padding:6px 10px">削除</button>
      </td>
    `;
    tr.querySelectorAll('button').forEach(btn=>{
      const act=btn.getAttribute('data-act');
      btn.addEventListener('click', ()=>{
        if(act==='inc') cart[id]++;
        if(act==='dec') cart[id]=Math.max(0,cart[id]-1);
        if(act==='del') delete cart[id];
        if(cart[id]===0) delete cart[id];
        updateCartCount();
        buildCart();
      });
    });
    cartBody.appendChild(tr);
  });
}

/* ====== 会計 → レシート描画（税計算なし & 不足額表示） ====== */
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  if(checkedOut) return;
  const items = Object.entries(cart).map(([id,qty])=>{
    const p = products.find(x=>x.id===id);
    return {...p, qty, subtotal:p.price*qty};
  });
  if(items.length===0){ alert('カートが空です'); return; }

  const total = items.reduce((a,b)=>a+b.subtotal,0);
  const qtySum= items.reduce((a,b)=>a+b.qty,0);
  const remain= wallet - total;
  const deficit = Math.max(0, total - wallet); // ← 不足額
  const receiptNo = Math.random().toString(36).slice(2,8).toUpperCase();

  // ヘッダー
  rMeta.innerHTML = `
    <div>日時</div><div>${nowStr()}</div>
    <div>レシートNo</div><div>${receiptNo}</div>
    <div>担当</div><div>CM-01</div>
    <div>お客さま</div><div>${esc(playerName)}</div>
  `;

  // 明細
  rItems.innerHTML = items.map(it => `
    <div>
      ${esc(it.name)} ×${it.qty}<br>
      <small>@¥${yen(it.price)}</small>
    </div>
    <div style="text-align:right">¥${yen(it.subtotal)}</div>
  `).join('');

  // 合計のみ表示
  rSum.innerHTML = `
    <div class="r-strong">合計</div><div class="r-strong">¥${yen(total)}</div>
    <div>お預り</div><div>¥${yen(wallet)}</div>
    <div>おつり</div><div>¥${yen(Math.max(0, wallet-total))}</div>
    <div>お買上点数</div><div>${qtySum} 点</div>
  `;

  // 結果（不足額の明示）
  finalStatus.className = 'status ' + (remain<0 ? 'bad' : 'ok');
  finalStatus.textContent =
    remain<0 ? `💥 ゲームオーバー！所持金不足（不足額：¥${yen(deficit)}）` :
    remain===0 ? '🎯 ピッタリ買い！' :
    `✅ 会計完了 残額 ¥${yen(remain)}`;

  // 画面遷移：レシートのみ
  shopPanel.style.display='none';
  cartPanel.style.display='none';
  finalPanel.style.display='block';
  checkedOut = true;
});

/* ====== 発行（画像保存：レシート部分のみ） ====== */
document.getElementById('saveBtn').addEventListener('click', ()=>{
  html2canvas(receiptPaper, {scale:2, backgroundColor:null}).then(canvas=>{
    const a=document.createElement('a');
    a.download=`receipt_${playerName}.png`;
    a.href=canvas.toDataURL('image/png');
    a.click();
  });
});

/* ====== リトライ／リセット ====== */
document.getElementById('retryBtn').addEventListener('click', ()=>{
  cart={}; checkedOut=false; updateCartCount();
  finalPanel.style.display='none';
  shopPanel.style.display='block';
});
document.getElementById('resetBtn').addEventListener('click', ()=>{
  playerName=''; wallet=null; cart={}; checkedOut=false;
  document.getElementById('nameInput').value='';
  walletDisplay.textContent='0';
  finalPanel.style.display='none';
  shopPanel.style.display='none';
  cartPanel.style.display='none';
  startPanel.style.display='block';
});
</script>
</body>
</html>
